# 20251116 OddAgent 工作流程调整

## 当前OddAgent的流程图

```mermaid
flowchart TD
    subgraph 用户层
        A[用户输入请求] -->|HTTP请求| B
    end

    subgraph 入口层
        B[Flask]-->|/oddagent/chat|D[api_oddagent_chat<br>接收问题]
    end

    subgraph 核心逻辑层
        D --> E[OddAgent<br>process_oddagent_chat]
        E -->|添加聊天记录| F{是否有当前工具?}
        F -->|否| G[识别用户意图<br>recognize_intent]
        G -->|识别成功| H[设置current_purpose]
        G -->|识别失败| I[生成默认回复<br>generate_default_response]
        F -->|是| J[标记为补槽阶段]
        J --> K{检测工具切换意图?}
        K -->|是| L[重置当前工具<br>reset_current_tool]
        L --> G
        K -->|否| M[加载工具处理器<br>load_processor]
    end

    subgraph 工具处理层
        M --> N[ToolProcessorImpl<br>process]
        N -->|更新槽位| O{槽位是否填满?}
        O -->|是| P[处理完整数据<br>process_complete_data]
        O -->|否| Q[处理补槽数据<br>process_more_slot_data]
        P --> R[调用工具执行器<br>ToolExecuterImpl.execute]
        R --> S{API_FAKE_API_RESULT?}
        S -->|模拟结果| T[返回模拟数据]
        S -->|真实调用| U[调用实际API]
        S -->|会议相关| V[MeetingExecuter处理]
    end

    subgraph 配置与工具层
        W[加载工具配置<br>load_all_tool_config] -->|读取JSON| X[工具配置数据]
        X --> E
        Y[LLM交互<br>llm_chat] -->|提供AI能力| G
        Y -->|提供AI能力| N
    end

    I --> Z[返回响应]
    Q --> Z
    T --> Z
    U --> Z
    V --> Z
    Z -->|JSON响应| AA[返回给用户]
```

## 设计变更

考虑到在实际的需求中，最终调用的工具及其API可能不是自己实现的，而是第三方的，最后这些工具及API千奇百怪的各种实现方法都有，无法简单将其API接口及参数等进行规约，因此，拟对OddAgent设计上进行调整，将其现有的工具调用部分进行剥离。

拟调整的方向如下图所示。

```mermaid
	sequenceDiagram
	rect rgb(222,255,255)
	前端 ->> OddAgent: 呼叫韦国华
	OddAgent ->> LLM: 意图识别
	LLM -->> OddAgent: 呼叫
	OddAgent ->> LLM: 槽位解析
	LLM -->> OddAgent: 韦国华
	OddAgent -->> 前端: invite+韦国华
	前端 ->> 会管: 查询 "韦国华"
	会管 -->> 前端: 返回多个结果：韦国华1，韦国华2，韦国华3
	前端 -->> 前端: 选择呼叫对象为韦国华3
	前端 ->> 会管: invite韦国华3
	会管 -->> 前端: 呼叫成功
	end
```

整个流程里OddAgent后端只负责意图识别、槽位解析，以及在槽位不满、需要多轮交互的场景下的会话管理，槽位补齐的工作。

## 调整后的流程图


```mermaid
flowchart TD
    subgraph 前端
        A[用户输入请求] -->|HTTP请求: 呼叫韦国华| B
    end

	subgraph OddAgent

		subgraph 配置及初始化层
			A1[加载工具配置<br>load_all_tool_config] -->|读取JSON| A2[工具配置数据]
		end
		
		subgraph 入口层
			B[Flask]-->|/oddagent/chat|D[api_oddagent_chat<br>接收问题]
		end

		subgraph 核心逻辑层
			D --> E[OddAgent<br>process_oddagent_chat]
			E -->|添加聊天记录| F{是否有当前工具?}
			F -->|否| G[识别用户意图<br>recognize_intent]
			G -->|识别成功| H[设置current_purpose]
			H --> F
			G -->|识别失败| I[生成默认回复<br>generate_default_response]
			F -->|是| J[标记为补槽阶段]
			J --> K{检测工具切换意图?}
			K -->|是| L[重置当前工具<br>reset_current_tool]
			L --> G
			K -->|否| M[加载工具处理器<br>load_processor]
		end

	end

	subgraph 工具处理层
		M --> N[ToolProcessorImpl<br>process]
		N -->|更新槽位| O{槽位是否填满?}
		O -->|是| P[处理完整数据<br>process_complete_data]
		O -->|否| Q[处理补槽数据<br>process_more_slot_data]
	end

	subgraph LLM大模型工具层
		Y[LLM交互<br>llm_chat] -->|提供AI能力| G
		Y -->|提供AI能力| N
	end

    I --> Z[返回响应]
	P --> Z
    Q --> Z
    Z -->|JSON响应| AA((返回给用户))
```